{% extends 'dashboard/base.html.twig' %}

{% block title %}Webhooks - Pushify{% endblock %}
{% block page_title %}Webhooks{% endblock %}
{% block page_subtitle %}Send notifications to external services{% endblock %}

{% block topbar_actions %}
<a href="{{ path('app_webhook_new') }}" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white font-medium rounded-lg transition-all inline-flex items-center gap-2">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
    </svg>
    New Webhook
</a>
{% endblock %}

{% block content %}
<div class="space-y-6">
    {% if webhooks is empty %}
    <div class="bg-gray-800/50 border border-gray-700/50 rounded-xl p-12 text-center">
        <div class="w-16 h-16 bg-gray-700/50 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
            </svg>
        </div>
        <h3 class="text-lg font-medium text-white mb-2">No webhooks configured</h3>
        <p class="text-gray-400 mb-6">Get notified about deployments via Slack, Discord, or custom webhooks</p>
        <a href="{{ path('app_webhook_new') }}" class="inline-flex items-center gap-2 px-6 py-3 bg-primary hover:bg-primary/90 text-white font-semibold rounded-lg">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Create Webhook
        </a>
    </div>
    {% else %}
    <div class="bg-gray-800/50 border border-gray-700/50 rounded-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-700/50">
            <h3 class="text-lg font-semibold text-white">Your Webhooks</h3>
            <p class="text-sm text-gray-400">{{ webhooks|length }} webhook{{ webhooks|length != 1 ? 's' : '' }} configured</p>
        </div>

        <div class="divide-y divide-gray-700/50">
            {% for webhook in webhooks %}
            <div class="p-6 hover:bg-gray-700/20 transition-colors" x-data="{ testing: false, testResult: null }">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <!-- Preset Icon -->
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center
                            {% if webhook.preset == 'slack' %}bg-purple-500/20{% elseif webhook.preset == 'discord' %}bg-indigo-500/20{% elseif webhook.preset == 'teams' %}bg-blue-500/20{% else %}bg-gray-700/50{% endif %}">
                            {% if webhook.preset == 'slack' %}
                            <svg class="w-6 h-6 text-purple-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/>
                            </svg>
                            {% elseif webhook.preset == 'discord' %}
                            <svg class="w-6 h-6 text-indigo-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189Z"/>
                            </svg>
                            {% elseif webhook.preset == 'teams' %}
                            <svg class="w-6 h-6 text-blue-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.625 8.073c-.002-.002-.007 0-.01 0a3.434 3.434 0 01-.676.067 3.456 3.456 0 003.39-4.066 3.456 3.456 0 00-5.89-.873 5.193 5.193 0 00-3.064-.997c-2.88 0-5.217 2.337-5.217 5.217v4.034c0 .17.031.336.088.49a1.93 1.93 0 00-.088.575v5.025c0 1.065.864 1.93 1.93 1.93h6.856c1.066 0 1.93-.865 1.93-1.93V12.52a1.93 1.93 0 00-.489-1.285 5.19 5.19 0 001.24-3.162zm-5.21 8.572a.482.482 0 01-.482.482h-4.021a.482.482 0 01-.483-.482v-4.021a.482.482 0 01.483-.483h4.02c.267 0 .483.216.483.483v4.02z"/>
                            </svg>
                            {% else %}
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                            {% endif %}
                        </div>

                        <div>
                            <div class="flex items-center gap-2">
                                <h4 class="font-medium text-white">{{ webhook.name }}</h4>
                                <span class="px-2 py-0.5 text-xs rounded-full {{ webhook.statusBadgeClass }}">
                                    {{ webhook.statusLabel }}
                                </span>
                            </div>
                            <p class="text-sm text-gray-400 mt-1">{{ webhook.presetLabel }}</p>
                            <div class="flex items-center gap-3 mt-2 text-xs text-gray-500">
                                {% if webhook.project %}
                                <span class="inline-flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                    </svg>
                                    {{ webhook.project.name }}
                                </span>
                                {% else %}
                                <span class="text-primary">All Projects</span>
                                {% endif %}
                                <span>{{ webhook.events|length }} event{{ webhook.events|length != 1 ? 's' : '' }}</span>
                                {% if webhook.lastTriggeredAt %}
                                <span>Last triggered {{ webhook.lastTriggeredAt|date('M d, H:i') }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <!-- Test Button -->
                        <button @click="testing = true; fetch('{{ path('app_webhook_test', {id: webhook.id}) }}', {method: 'POST'}).then(r => r.json()).then(d => { testResult = d; testing = false; })"
                                :disabled="testing"
                                class="px-3 py-1.5 text-sm bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors disabled:opacity-50">
                            <span x-show="!testing">Test</span>
                            <span x-show="testing">Testing...</span>
                        </button>

                        <!-- Toggle -->
                        <button onclick="toggleWebhook({{ webhook.id }}, this)"
                                class="px-3 py-1.5 text-sm rounded-lg transition-colors {{ webhook.isActive ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30' : 'bg-gray-700 text-gray-400 hover:bg-gray-600' }}">
                            {{ webhook.isActive ? 'Enabled' : 'Disabled' }}
                        </button>

                        <!-- Edit -->
                        <a href="{{ path('app_webhook_edit', {id: webhook.id}) }}"
                           class="px-3 py-1.5 text-sm bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">
                            Edit
                        </a>

                        <!-- Delete -->
                        <form method="post" action="{{ path('app_webhook_delete', {id: webhook.id}) }}"
                              onsubmit="return confirm('Are you sure you want to delete this webhook?')">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete-webhook-' ~ webhook.id) }}">
                            <button type="submit" class="px-3 py-1.5 text-sm bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-colors">
                                Delete
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Test Result -->
                <div x-show="testResult" x-transition class="mt-4 p-3 rounded-lg"
                     :class="testResult?.success ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'">
                    <p :class="testResult?.success ? 'text-green-400' : 'text-red-400'">
                        <span x-show="testResult?.success">Test successful! Status: <span x-text="testResult?.statusCode"></span></span>
                        <span x-show="!testResult?.success">Test failed: <span x-text="testResult?.error || 'HTTP ' + testResult?.statusCode"></span></span>
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Help Section -->
    <div class="bg-gray-800/50 border border-gray-700/50 rounded-xl p-6">
        <h3 class="text-lg font-semibold text-white mb-4">Quick Setup Guides</h3>
        <div class="grid grid-cols-3 gap-4">
            <div class="p-4 bg-gray-900/50 rounded-lg">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 bg-purple-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-purple-400" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52z"/>
                        </svg>
                    </div>
                    <h4 class="font-medium text-white">Slack</h4>
                </div>
                <p class="text-sm text-gray-400">Create an Incoming Webhook in Slack and paste the URL here.</p>
            </div>
            <div class="p-4 bg-gray-900/50 rounded-lg">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 bg-indigo-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-indigo-400" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495"/>
                        </svg>
                    </div>
                    <h4 class="font-medium text-white">Discord</h4>
                </div>
                <p class="text-sm text-gray-400">Create a Webhook in Discord channel settings and use the URL.</p>
            </div>
            <div class="p-4 bg-gray-900/50 rounded-lg">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 bg-gray-700 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                        </svg>
                    </div>
                    <h4 class="font-medium text-white">Custom</h4>
                </div>
                <p class="text-sm text-gray-400">Send JSON payloads to any HTTP endpoint with optional signing.</p>
            </div>
        </div>
    </div>
</div>

<script>
async function toggleWebhook(id, btn) {
    try {
        const response = await fetch(`/dashboard/webhooks/${id}/toggle`, { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            location.reload();
        }
    } catch (e) {
        console.error('Failed to toggle webhook:', e);
    }
}
</script>
{% endblock %}
