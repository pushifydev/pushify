{% extends 'dashboard/base.html.twig' %}

{% block title %}Settings -
	{{ project.name }}
	- Pushify
{% endblock %}
{% block page_title %}
	{{ project.name }}
	Settings
{% endblock %}
{% block page_subtitle %}Configure your project settings
{% endblock %}

{% block topbar_actions %}
	<a href="{{ path('app_project_show', {slug: project.slug}) }}" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-all inline-flex items-center gap-2">
		<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
		</svg>
		Back to Project
	</a>
{% endblock %}

{% block content %}
	<div
		class="max-w-3xl space-y-6">
		<!-- General Settings -->
		<form method="post" class="bg-gray-800/50 border border-gray-700/50 rounded-xl p-6">
			<h3 class="text-lg font-semibold text-white mb-6">General Settings</h3>

			<div
				class="space-y-4">
				<!-- Project Name -->
				<div>
					<label for="name" class="block text-sm font-medium text-gray-300 mb-2">Project Name</label>
					<input type="text" id="name" name="name" value="{{ project.name }}" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
				</div>

				<!-- Framework -->
				<div>
					<label for="framework" class="block text-sm font-medium text-gray-300 mb-2">Framework</label>
					<select id="framework" name="framework" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
						{% for label, value in frameworks %}
							<option value="{{ value }}" {{ value == project.framework ? 'selected' : '' }}>
								{{ label }}
							</option>
						{% endfor %}
					</select>
				</div>

				<!-- Branch -->
				<div>
					<label for="branch" class="block text-sm font-medium text-gray-300 mb-2">Production Branch</label>
					<input type="text" id="branch" name="branch" value="{{ project.branch }}" placeholder="main" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary font-mono text-sm">
				</div>

				<!-- Auto Deploy -->
				<div class="flex items-center justify-between p-4 bg-gray-900/50 rounded-lg">
					<div>
						<p class="font-medium text-white">Auto Deploy</p>
						<p class="text-sm text-gray-400">Automatically deploy when pushing to production branch</p>
					</div>
					<label class="relative inline-flex items-center cursor-pointer">
						<input type="checkbox" name="autoDeployEnabled" value="1" {{ project.autoDeployEnabled ? 'checked' : '' }} class="sr-only peer">
						<div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
					</label>
				</div>

				<!-- Preview Deployments -->
				<div class="flex items-center justify-between p-4 bg-gray-900/50 rounded-lg">
					<div>
						<p class="font-medium text-white">Preview Deployments</p>
						<p class="text-sm text-gray-400">Automatically create preview environments for pull requests</p>
					</div>
					<label class="relative inline-flex items-center cursor-pointer">
						<input type="checkbox" name="previewDeploymentsEnabled" value="1" {{ project.previewDeploymentsEnabled ? 'checked' : '' }} class="sr-only peer">
						<div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
					</label>
				</div>
			</div>

			<div class="mt-6 pt-6 border-t border-gray-700">
				<button type="submit" class="px-6 py-3 bg-primary hover:bg-primary/90 text-white font-semibold rounded-lg transition-all">
					Save Changes
				</button>
			</div>
		</form>

		<!-- Build Settings -->
		<form method="post" class="bg-gray-800/50 border border-gray-700/50 rounded-xl p-6">
			<h3 class="text-lg font-semibold text-white mb-2">Build & Output Settings</h3>
			<p class="text-sm text-gray-400 mb-4">Configure build commands for your project</p>

			<!-- Custom Dockerfile Info -->
			<div class="mb-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
				<div class="flex items-start gap-3">
					<svg class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
					</svg>
					<div>
						<p class="text-sm font-medium text-blue-300 mb-1">ðŸ’¡ Pro Tip: Custom Dockerfile Support</p>
						<p class="text-xs text-gray-400">Add a <code class="px-1.5 py-0.5 bg-gray-900 rounded text-blue-300 font-mono">Dockerfile</code> to your repository root for complete control. If present, it will be used instead of auto-generated builds. Perfect for Prisma, custom build steps, or complex setups.</p>
					</div>
				</div>
			</div>

			<div
				class="space-y-4">
				<!-- Root Directory -->
				<div>
					<label for="rootDirectory" class="block text-sm font-medium text-gray-300 mb-2">Root Directory</label>
					<input type="text" id="rootDirectory" name="rootDirectory" value="{{ project.rootDirectory }}" placeholder="./" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary font-mono text-sm">
					<p class="text-xs text-gray-500 mt-1">The directory where your source code is located</p>
				</div>

				<!-- Install Command -->
				<div>
					<label for="installCommand" class="block text-sm font-medium text-gray-300 mb-2">Install Command</label>
					<input type="text" id="installCommand" name="installCommand" value="{{ project.installCommand }}" placeholder="npm install" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary font-mono text-sm">
				</div>

				<!-- Build Command -->
				<div>
					<label for="buildCommand" class="block text-sm font-medium text-gray-300 mb-2">Build Command</label>
					<input type="text" id="buildCommand" name="buildCommand" value="{{ project.buildCommand }}" placeholder="npm run build" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary font-mono text-sm">
				</div>

				<!-- Start Command -->
				<div>
					<label for="startCommand" class="block text-sm font-medium text-gray-300 mb-2">Start Command</label>
					<input type="text" id="startCommand" name="startCommand" value="{{ project.startCommand }}" placeholder="npm start" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary font-mono text-sm">
					<p class="text-xs text-gray-500 mt-1">Command used to start your application in production</p>
				</div>

				<!-- Output Directory -->
				<div>
					<label for="outputDirectory" class="block text-sm font-medium text-gray-300 mb-2">Output Directory</label>
					<input type="text" id="outputDirectory" name="outputDirectory" value="{{ project.outputDirectory }}" placeholder="dist" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary font-mono text-sm">
					<p class="text-xs text-gray-500 mt-1">Directory containing your built application</p>
				</div>
			</div>

			<div class="mt-6 pt-6 border-t border-gray-700">
				<button type="submit" class="px-6 py-3 bg-primary hover:bg-primary/90 text-white font-semibold rounded-lg transition-all">
					Save Changes
				</button>
			</div>
		</form>

		<!-- Deployment Server -->
		<form method="post" class="bg-gray-800/50 border border-gray-700/50 rounded-xl p-6">
			<h3 class="text-lg font-semibold text-white mb-2">Deployment Server</h3>
			<p class="text-sm text-gray-400 mb-6">Select the server where your application will be deployed</p>

			<div class="space-y-4">
				<div>
					<label for="server" class="block text-sm font-medium text-gray-300 mb-2">Server</label>
					<select id="server" name="server_id" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
						<option value="">-- No server (local deployment) --</option>
						{% for server in servers %}
							<option value="{{ server.id }}" {{ project.server and project.server.id == server.id ? 'selected' : '' }}>
								{{ server.name }} ({{ server.ipAddress }})
								{% if not server.isActive %} - Offline{% endif %}
								{% if not server.dockerInstalled %} - Docker not installed{% endif %}
							</option>
						{% endfor %}
					</select>
					<p class="text-xs text-gray-500 mt-2">
						{% if servers is empty %}
							No servers available. <a href="{{ path('app_server_new') }}" class="text-primary hover:underline">Add a server</a>
						{% else %}
							Choose where to deploy your application
						{% endif %}
					</p>
				</div>

				{% if project.server %}
				<div class="p-4 bg-gray-900/50 rounded-lg">
					<div class="flex items-center justify-between">
						<div>
							<p class="font-medium text-white">{{ project.server.name }}</p>
							<p class="text-sm text-gray-400">{{ project.server.ipAddress }}{% if project.containerPort %} : {{ project.containerPort }}{% endif %}</p>
						</div>
						<span class="px-3 py-1 rounded-full text-sm {{ project.server.statusBadgeClass }}">
							{{ project.server.status|capitalize }}
						</span>
					</div>
					{% if project.productionUrl %}
					<div class="mt-3 pt-3 border-t border-gray-700">
						<p class="text-xs text-gray-500 mb-1">Production URL</p>
						<a href="{{ project.productionUrl }}" target="_blank" class="text-primary hover:underline text-sm">{{ project.productionUrl }}</a>
					</div>
					{% endif %}
				</div>
				{% endif %}
			</div>

			<div class="mt-6 pt-6 border-t border-gray-700">
				<button type="submit" class="px-6 py-3 bg-primary hover:bg-primary/90 text-white font-semibold rounded-lg transition-all">
					Save Server Selection
				</button>
			</div>
		</form>

		<!-- Git Integration / Webhooks -->
		<div class="bg-gray-800/50 border border-gray-700/50 rounded-xl p-6">
			<h3 class="text-lg font-semibold text-white mb-2">Git Integration</h3>
			<p class="text-sm text-gray-400 mb-6">Configure automatic deployments from GitHub</p>

			<div class="space-y-4">
				<!-- Webhook URL -->
				<div>
					<label class="block text-sm font-medium text-gray-300 mb-2">Webhook URL</label>
					<div class="flex gap-2">
						<input type="text"
							   value="{{ app.request.schemeAndHttpHost }}{{ project.webhookUrl }}"
							   readonly
							   id="webhook-url"
							   class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-300 font-mono text-sm">
						<button type="button"
								onclick="navigator.clipboard.writeText(document.getElementById('webhook-url').value); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy', 2000)"
								class="px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors">
							Copy
						</button>
					</div>
					<p class="text-xs text-gray-500 mt-2">Add this URL as a webhook in your GitHub repository settings</p>
				</div>

				<!-- Setup Instructions -->
				<div class="p-4 bg-gray-900/50 rounded-lg">
					<h4 class="text-sm font-medium text-white mb-3">Setup Instructions</h4>
					<ol class="text-sm text-gray-400 space-y-2 list-decimal list-inside">
						<li>Go to your repository on GitHub</li>
						<li>Navigate to <span class="text-gray-300">Settings â†’ Webhooks â†’ Add webhook</span></li>
						<li>Paste the Webhook URL above in the "Payload URL" field</li>
						<li>Set Content type to <span class="font-mono text-gray-300">application/json</span></li>
						<li>Select <span class="text-gray-300">"Let me select individual events"</span> and check:
							<ul class="ml-4 mt-1 space-y-1">
								<li class="text-gray-500">â€¢ <span class="text-gray-300">Pushes</span> - for auto-deploy on push</li>
								<li class="text-gray-500">â€¢ <span class="text-gray-300">Pull requests</span> - for preview deployments</li>
							</ul>
						</li>
						<li>Click "Add webhook"</li>
					</ol>
				</div>

				<!-- Repository Info -->
				<div class="flex items-center justify-between p-4 bg-gray-900/50 rounded-lg">
					<div>
						<p class="font-medium text-white">{{ project.repositoryName }}</p>
						<p class="text-sm text-gray-400">Branch: {{ project.branch }}</p>
					</div>
					<a href="{{ project.repositoryUrl }}/settings/hooks/new"
					   target="_blank"
					   class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors inline-flex items-center gap-2">
						<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
							<path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
						</svg>
						Add Webhook on GitHub
					</a>
				</div>
			</div>
		</div>

		<!-- Danger Zone -->
		<div class="bg-red-500/10 border border-red-500/30 rounded-xl p-6">
			<h3 class="text-lg font-semibold text-red-400 mb-4">Danger Zone</h3>
			<p class="text-gray-400 mb-4">Deleting your project will permanently remove all deployments, domains, and settings associated with it.</p>
			<form method="post" action="{{ path('app_project_delete', {slug: project.slug}) }}" onsubmit="return confirm('Are you sure you want to delete this project? This action cannot be undone.');">
				<input type="hidden" name="_token" value="{{ csrf_token('delete-project-' ~ project.id) }}">
				<button type="submit" class="px-6 py-3 bg-red-500/20 hover:bg-red-500/30 text-red-400 font-semibold rounded-lg transition-all border border-red-500/30">
					Delete Project
				</button>
			</form>
		</div>
	</div>
{% endblock %}
