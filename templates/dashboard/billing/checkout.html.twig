{% extends 'dashboard/base.html.twig' %}

{% block title %}Checkout - Pushify
{% endblock %}
{% block page_title %}Complete Your Purchase
{% endblock %}
{% block page_subtitle %}Subscribe to create and manage your servers
{% endblock %}

{% block content %}
	<div
		class="max-w-4xl mx-auto">
		<!-- Server Type Selector -->
		<div class="bg-gray-800/50 border border-gray-700/50 rounded-xl p-6 mb-6">
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-white">Select Server Type</h3>
				<button type="button" id="toggleAllServers" class="text-sm text-primary hover:text-primary/80 transition-colors">
					View all server types
				</button>
			</div>

			<!-- Selected Server Display -->
			{% set selected_option = null %}
			{% for option in server_options %}
				{% if option.name == server_type %}
					{% set selected_option = option %}
				{% endif %}
			{% endfor %}

			<div class="mb-4 p-4 bg-gray-900/50 rounded-lg border-2 border-primary">
				<div class="flex items-center justify-between">
					<div class="flex-1">
						<div class="flex items-center gap-2 mb-1">
							<h4 class="font-bold text-white">{{ selected_option.name|upper }}</h4>
							{% if selected_option.name == 'cx22' %}
								<span class="px-2 py-0.5 bg-primary/20 text-primary text-xs rounded-full">Recommended</span>
							{% endif %}
						</div>
						<p class="text-sm text-gray-400">
							{% if selected_option.cores and selected_option.memory and selected_option.disk %}
								{{ selected_option.cores }}
								vCPU •
								{{ selected_option.memory }}GB RAM •
								{{ selected_option.disk }}GB SSD
							{% else %}
								{{ selected_option.name|upper }}
								Server
							{% endif %}
						</p>
					</div>
					<div class="text-right">
						<p class="text-2xl font-bold text-primary">€{{ selected_option.pricing.final_price_eur }}</p>
						<p class="text-xs text-gray-500">/mo</p>
					</div>
				</div>
			</div>

			<!-- Popular Options (First 4) -->
			<div class="grid md:grid-cols-4 gap-3">
				{% set popular_count = 0 %}
				{% for option in server_options %}
					{% if popular_count < 4 and option.name in ['cx11', 'cx22', 'cx31', 'cx41'] %}
						{% set popular_count = popular_count + 1 %}
						<a href="{{ path('app_billing_checkout_page', {server_type: option.name}) }}" class="p-3 rounded-lg border-2 transition-all text-center {{ server_type == option.name ? 'border-primary bg-primary/10' : 'border-gray-700 hover:border-gray-600' }}">
							<h4 class="font-bold text-white text-sm mb-1">{{ option.name|upper }}</h4>
							<p class="text-xs text-gray-400 mb-2">
								{% if option.cores %}
									{{ option.cores }}
									vCPU •
									{{ option.memory }}GB
								{% endif %}
							</p>
							<p class="text-sm font-bold text-primary">€{{ option.pricing.final_price_eur }}/mo</p>
						</a>
					{% endif %}
				{% endfor %}
			</div>

			<!-- All Server Types (Hidden by default) -->
			<div id="allServerTypes" class="hidden mt-4 pt-4 border-t border-gray-700/50">
				<div class="grid md:grid-cols-5 gap-3">
					{% for option in server_options %}
						<a href="{{ path('app_billing_checkout_page', {server_type: option.name}) }}" class="p-3 rounded-lg border-2 transition-all text-center {{ server_type == option.name ? 'border-primary bg-primary/10' : 'border-gray-700 hover:border-gray-600' }}">
							<h4 class="font-bold text-white text-sm mb-1">{{ option.name|upper }}</h4>
							<p class="text-xs text-gray-400 mb-2">
								{% if option.cores %}
									{{ option.cores }}
									vCPU •
									{{ option.memory }}GB
								{% endif %}
							</p>
							<p class="text-sm font-bold text-primary">€{{ option.pricing.final_price_eur }}/mo</p>
						</a>
					{% endfor %}
				</div>
			</div>

			<script>
				document.getElementById('toggleAllServers').addEventListener('click', function () {
const allServers = document.getElementById('allServerTypes');
const isHidden = allServers.classList.contains('hidden');

if (isHidden) {
allServers.classList.remove('hidden');
this.textContent = 'Show less';
} else {
allServers.classList.add('hidden');
this.textContent = 'View all server types';
}
});
			</script>
		</div>

		<div
			class="grid md:grid-cols-2 gap-8">
			<!-- Left: Payment Form -->
			<div>
				<div class="bg-gray-800/50 border border-gray-700/50 rounded-xl p-6">
					<h3 class="text-xl font-semibold text-white mb-6">Payment Details</h3>

					<div {{ react_component('billing/PaymentForm', { 'serverType': server_type, 'amount': pricing.final_price_eur, 'csrfToken': csrf_token('checkout') } ) }}></div>
				</div>
			</div>

			<!-- Right: Order Summary -->
			<div>
				<div class="bg-gray-800/50 border border-gray-700/50 rounded-xl p-6 sticky top-6">
					<h3 class="text-xl font-semibold text-white mb-6">Order Summary</h3>

					<div
						class="space-y-4">
						<!-- Server Details -->
						<div class="p-4 bg-gray-900/50 rounded-lg">
							<div class="flex items-center justify-between mb-3">
								<span class="text-sm font-medium text-gray-400">Server Type</span>
								<span class="text-sm font-bold text-white">{{ server_type|upper }}</span>
							</div>

							<div class="space-y-2 text-sm text-gray-400">
								{% set selected_option = null %}
								{% for option in server_options %}
									{% if option.name == server_type %}
										{% set selected_option = option %}
									{% endif %}
								{% endfor %}

								{% if selected_option and selected_option.cores %}
									<div class="flex items-center gap-2">
										<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
										</svg>
										<span>{{ selected_option.cores }}
											vCPU</span>
									</div>
									<div class="flex items-center gap-2">
										<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
										</svg>
										<span>{{ selected_option.memory }}
											GB RAM</span>
									</div>
									<div class="flex items-center gap-2">
										<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
										</svg>
										<span>{{ selected_option.disk }}
											GB SSD</span>
									</div>
								{% endif %}
							</div>
						</div>

						<!-- Pricing Breakdown -->
						<div class="space-y-3 py-4 border-t border-b border-gray-700/50">
							<div class="flex items-center justify-between text-sm">
								<span class="text-gray-400">Server Cost (Hetzner)</span>
								<span class="text-gray-300">€{{ pricing.cost_eur }}</span>
							</div>
							<div class="flex items-center justify-between text-sm">
								<span class="text-gray-400">Platform Fee ({{ pricing.markup_percentage }}%)</span>
								<span class="text-gray-300">€{{ (pricing.final_price_eur - pricing.cost_eur)|number_format(2, '.', ',') }}</span>
							</div>
							<div class="flex items-center justify-between text-lg font-bold">
								<span class="text-white">Total (Monthly)</span>
								<span class="text-primary">€{{ pricing.final_price_eur }}</span>
							</div>
							<div class="text-xs text-gray-500 text-center">
								≈ ${{ pricing.final_price_usd }}
								USD
							</div>
						</div>

						<!-- Features -->
						<div class="space-y-2">
							<h4 class="text-sm font-semibold text-white mb-3">What's Included</h4>
							<div class="space-y-2 text-sm text-gray-400">
								<div class="flex items-center gap-2">
									<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
									</svg>
									<span>Unlimited projects</span>
								</div>
								<div class="flex items-center gap-2">
									<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
									</svg>
									<span>Auto SSL certificates</span>
								</div>
								<div class="flex items-center gap-2">
									<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
									</svg>
									<span>Docker & Git support</span>
								</div>
								<div class="flex items-center gap-2">
									<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
									</svg>
									<span>Database backups</span>
								</div>
								<div class="flex items-center gap-2">
									<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
									</svg>
									<span>24/7 monitoring</span>
								</div>
								<div class="flex items-center gap-2">
									<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
									</svg>
									<span>Cancel anytime</span>
								</div>
							</div>
						</div>

						<!-- Money Back -->
						<div class="p-3 bg-green-500/10 border border-green-500/30 rounded-lg">
							<p class="text-xs text-green-400 text-center">
								7-day money-back guarantee. No questions asked.
							</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
